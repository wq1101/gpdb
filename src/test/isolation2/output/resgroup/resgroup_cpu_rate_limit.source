-- start_ignore
DROP VIEW IF EXISTS cancel_all;
DROP
DROP ROLE IF EXISTS role1_cpu_test;
DROP
DROP ROLE IF EXISTS role2_cpu_test;
DROP
DROP RESOURCE GROUP rg1_cpu_test;
ERROR:  resource group "rg1_cpu_test" does not exist
DROP RESOURCE GROUP rg2_cpu_test;
ERROR:  resource group "rg2_cpu_test" does not exist

CREATE LANGUAGE plpythonu;
CREATE
-- end_ignore

--
-- helper functions, tables and views
--

DROP TABLE IF EXISTS cpu_usage_samples;
DROP
CREATE TABLE cpu_usage_samples (sample text);
CREATE

-- fetch_sample: select cpu_usage from gp_toolkit.gp_resgroup_status
-- and dump them into text in json format then save them in db for
-- further analysis.
CREATE OR REPLACE FUNCTION fetch_sample() RETURNS text AS $$ import json 
group_cpus = plpy.execute(''' SELECT rsgname, cpu_usage FROM gp_toolkit.gp_resgroup_status ''') json_text = json.dumps(dict([(row['rsgname'], json.loads(row['cpu_usage'])) for row in group_cpus])) plpy.execute(''' INSERT INTO cpu_usage_samples VALUES ('{value}') '''.format(value=json_text)) return json_text $$ LANGUAGE plpythonu;
CREATE

-- verify_cpu_usage: calculate each QE's average cpu usage using all the data in
-- the table cpu_usage_sample. And compare the average value to the expected value.
-- return true if the practical value is close to the expected value.
CREATE OR REPLACE FUNCTION verify_cpu_usage(groupname TEXT, expect_cpu_usage INT, err_rate INT) RETURNS BOOL AS $$ import json 
def add_vector(vec1, vec2): r = dict() for seg_id1, value1 in vec1.items(): r[seg_id1] = value1 + vec2[seg_id1] return r 
def verify_cpu_usage(): all_info = plpy.execute(''' SELECT sample::json->'{name}' AS cpu FROM cpu_usage_samples '''.format(name=groupname)) usage_sum = reduce(add_vector, [json.loads(row['cpu']) for row in all_info]) usage = [(float(v) / all_info.nrows()) for k, v in usage_sum.items() if k != "-1"] avg = sum(usage) / len(usage) return abs(avg - expect_cpu_usage) <= err_rate 
return verify_cpu_usage() $$ LANGUAGE plpythonu;
CREATE

CREATE OR REPLACE FUNCTION busy() RETURNS void AS $$ import os import signal 
n = 15 for i in xrange(n): if os.fork() == 0: # children must quit without invoking the atexit hooks signal.signal(signal.SIGINT,  lambda a, b: os._exit(0)) signal.signal(signal.SIGQUIT, lambda a, b: os._exit(0)) signal.signal(signal.SIGTERM, lambda a, b: os._exit(0)) 
# generate pure cpu load while True: pass 
os.wait() $$ LANGUAGE plpythonu;
CREATE

CREATE VIEW cancel_all AS SELECT pg_cancel_backend(pid) FROM pg_stat_activity WHERE query LIKE 'SELECT * FROM % WHERE busy%';
CREATE

-- create two resource groups
CREATE RESOURCE GROUP rg1_cpu_test WITH (concurrency=5, cpu_rate_limit=10, memory_limit=20);
CREATE
CREATE RESOURCE GROUP rg2_cpu_test WITH (concurrency=5, cpu_rate_limit=20, memory_limit=20);
CREATE

--
-- check gpdb cgroup configuration
--
DO LANGUAGE PLPYTHONU $$ import subprocess 
cgroot = '@cgroup_mnt_point@' 
def get_cgroup_prop(prop): fullpath = cgroot + '/' + prop return int(open(fullpath).readline()) 
def run_command(cmd): return subprocess.check_output(cmd.split()) 
def show_guc(guc): return plpy.execute('SHOW {}'.format(guc))[0][guc] 
# # check gpdb top-level cgroup configuration # 
# get top-level cgroup props cfs_quota_us = get_cgroup_prop('/cpu/gpdb/cpu.cfs_quota_us') cfs_period_us = get_cgroup_prop('/cpu/gpdb/cpu.cfs_period_us') shares = get_cgroup_prop('/cpu/gpdb/cpu.shares') 
# get system props ncores = int(run_command('nproc')) 
# get global gucs gp_resource_group_cpu_limit = float(show_guc('gp_resource_group_cpu_limit')) gp_resource_group_cpu_priority = int(show_guc('gp_resource_group_cpu_priority')) 
# cfs_quota_us := cfs_period_us * ncores * gp_resource_group_cpu_limit assert cfs_quota_us == cfs_period_us * ncores * gp_resource_group_cpu_limit 
# shares := 1024 * gp_resource_group_cpu_priority assert shares == 1024 * gp_resource_group_cpu_priority 
# SUB/shares := TOP/shares * cpu_rate_limit def check_group_shares(name): cpu_rate_limit = int(plpy.execute(''' SELECT value FROM pg_resgroupcapability c, pg_resgroup g WHERE c.resgroupid=g.oid AND reslimittype=2 AND g.rsgname='{}' '''.format(name))[0]['value']) oid = int(plpy.execute(''' SELECT oid FROM pg_resgroup WHERE rsgname='{}' '''.format(name))[0]['oid']) sub_shares = get_cgroup_prop('/cpu/gpdb/{}/cpu.shares'.format(oid)) assert sub_shares == shares * cpu_rate_limit / 100 
# check default groups check_group_shares('default_group') check_group_shares('admin_group') 
# check user groups check_group_shares('rg1_cpu_test') check_group_shares('rg2_cpu_test') $$;
DO

-- lower admin_group's cpu_rate_limit to minimize its side effect
ALTER RESOURCE GROUP admin_group SET cpu_rate_limit 1;
ALTER

-- create two roles and assign them to above groups
CREATE ROLE role1_cpu_test RESOURCE GROUP rg1_cpu_test;
CREATE
CREATE ROLE role2_cpu_test RESOURCE GROUP rg2_cpu_test;
CREATE
GRANT ALL ON FUNCTION busy() TO role1_cpu_test;
GRANT
GRANT ALL ON FUNCTION busy() TO role2_cpu_test;
GRANT

-- prepare parallel queries in the two groups
10: SET ROLE TO role1_cpu_test;
SET
11: SET ROLE TO role1_cpu_test;
SET
12: SET ROLE TO role1_cpu_test;
SET
13: SET ROLE TO role1_cpu_test;
SET
14: SET ROLE TO role1_cpu_test;
SET

20: SET ROLE TO role2_cpu_test;
SET
21: SET ROLE TO role2_cpu_test;
SET
22: SET ROLE TO role2_cpu_test;
SET
23: SET ROLE TO role2_cpu_test;
SET
24: SET ROLE TO role2_cpu_test;
SET

--
-- now we get prepared.
--
-- on empty load the cpu usage shall be 0%
--

--
-- a group should burst to use all the cpu usage
-- when it's the only one with running queries.
--
-- however the overall cpu usage is controlled by a GUC
-- gp_resource_group_cpu_limit which is 90% by default.
--
-- so the cpu usage shall be 90%
--

10&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
11&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
12&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
13&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
14&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>

-- start_ignore
TRUNCATE TABLE cpu_usage_samples;
TRUNCATE
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 89.900000000000006, "0": 89.569999999999993, "2": 89.650000000000006, "-1": 90.480000000000004}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.01, "0": 0.01, "2": 0.01, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 90.109999999999999, "0": 90.209999999999994, "2": 90.090000000000003, "-1": 88.549999999999997}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.01, "0": 0.02, "2": 0.02, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 90.040000000000006, "0": 90.069999999999993, "2": 90.049999999999997, "-1": 87.859999999999999}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.02, "0": 0.02, "2": 0.01, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 90.030000000000001, "0": 90.260000000000005, "2": 90.140000000000001, "-1": 90.290000000000006}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.0, "0": 0.02, "2": 0.01, "-1": 0.080000000000000002}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 90.019999999999996, "0": 90.310000000000002, "2": 90.049999999999997, "-1": 90.700000000000003}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.02, "0": 0.02, "2": 0.02, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
TRUNCATE TABLE cpu_usage_samples;
TRUNCATE
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 90.129999999999995, "0": 90.159999999999997, "2": 90.120000000000005, "-1": 88.640000000000001}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.01, "0": 0.02, "2": 0.01, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 90.299999999999997, "0": 90.079999999999998, "2": 90.030000000000001, "-1": 90.730000000000004}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.02, "0": 0.02, "2": 0.01, "-1": 0.11}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                 
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 88.870000000000005, "0": 88.939999999999998, "2": 88.709999999999994, "-1": 89.810000000000002}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.01, "0": 0.029999999999999999, "2": 0.01, "-1": 0.089999999999999997}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                 
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 90.049999999999997, "0": 90.129999999999995, "2": 90.049999999999997, "-1": 88.400000000000006}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.01, "0": 0.02, "2": 0.01, "-1": 0.080000000000000002}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 90.269999999999996, "0": 90.079999999999998, "2": 90.269999999999996, "-1": 87.700000000000003}, "rg2_cpu_test": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}, "admin_group": {"1": 0.029999999999999999, "0": 0.01, "2": 0.02, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
-- end_ignore

SELECT verify_cpu_usage('rg1_cpu_test', 90, 10);
 verify_cpu_usage 
------------------
 t                
(1 row)

-- start_ignore
SELECT * FROM cancel_all;
 pg_cancel_backend 
-------------------
 t                 
 t                 
 t                 
 t                 
 t                 
(5 rows)

10<:  <... completed>
ERROR:  canceling statement due to user request
11<:  <... completed>
ERROR:  canceling statement due to user request
12<:  <... completed>
ERROR:  canceling statement due to user request
13<:  <... completed>
ERROR:  canceling statement due to user request
14<:  <... completed>
ERROR:  canceling statement due to user request
-- end_ignore

10q: ... <quitting>
11q: ... <quitting>
12q: ... <quitting>
13q: ... <quitting>
14q: ... <quitting>

10: SET ROLE TO role1_cpu_test;
SET
11: SET ROLE TO role1_cpu_test;
SET
12: SET ROLE TO role1_cpu_test;
SET
13: SET ROLE TO role1_cpu_test;
SET
14: SET ROLE TO role1_cpu_test;
SET

--
-- when there are multiple groups with parallel queries,
-- they should share the cpu usage by their cpu_usage settings,
--
-- rg1_cpu_test:rg2_cpu_test is 0.1:0.2 => 1:2, so:
--
-- - rg1_cpu_test gets 90% * 1/3 => 30%;
-- - rg2_cpu_test gets 90% * 2/3 => 60%;
--

10&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
11&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
12&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
13&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
14&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>

20&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
21&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
22&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
23&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>
24&: SELECT * FROM gp_dist_random('gp_id') WHERE busy() IS NULL;  <waiting ...>

-- start_ignore
TRUNCATE TABLE cpu_usage_samples;
TRUNCATE
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                                      
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 30.23, "0": 30.09, "2": 29.989999999999998, "-1": 29.57}, "rg2_cpu_test": {"1": 59.609999999999999, "0": 59.859999999999999, "2": 59.810000000000002, "-1": 58.880000000000003}, "admin_group": {"1": 0.02, "0": 0.029999999999999999, "2": 0.02, "-1": 0.080000000000000002}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 30.32, "0": 30.25, "2": 30.239999999999998, "-1": 29.260000000000002}, "rg2_cpu_test": {"1": 59.93, "0": 59.909999999999997, "2": 59.950000000000003, "-1": 58.520000000000003}, "admin_group": {"1": 0.01, "0": 0.02, "2": 0.02, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                                     
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 31.75, "0": 31.66, "2": 31.699999999999999, "-1": 30.84}, "rg2_cpu_test": {"1": 58.630000000000003, "0": 58.640000000000001, "2": 58.579999999999998, "-1": 57.439999999999998}, "admin_group": {"1": 0.02, "0": 0.029999999999999999, "2": 0.01, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 30.190000000000001, "0": 30.109999999999999, "2": 30.09, "-1": 30.039999999999999}, "rg2_cpu_test": {"1": 59.899999999999999, "0": 60.119999999999997, "2": 59.920000000000002, "-1": 60.520000000000003}, "admin_group": {"1": 0.02, "0": 0.02, "2": 0.01, "-1": 0.11}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                                                   
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 29.23, "0": 29.239999999999998, "2": 29.260000000000002, "-1": 29.219999999999999}, "rg2_cpu_test": {"1": 60.729999999999997, "0": 60.68, "2": 60.780000000000001, "-1": 60.969999999999999}, "admin_group": {"1": 0.029999999999999999, "0": 0.01, "2": 0.02, "-1": 0.089999999999999997}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
TRUNCATE TABLE cpu_usage_samples;
TRUNCATE
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                                            
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 25.890000000000001, "0": 25.879999999999999, "2": 25.879999999999999, "-1": 26.109999999999999}, "rg2_cpu_test": {"1": 64.090000000000003, "0": 64.069999999999993, "2": 64.069999999999993, "-1": 64.329999999999998}, "admin_group": {"1": 0.0, "0": 0.02, "2": 0.02, "-1": 0.11}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                                   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 25.940000000000001, "0": 25.879999999999999, "2": 25.809999999999999, "-1": 26.149999999999999}, "rg2_cpu_test": {"1": 63.57, "0": 63.710000000000001, "2": 62.909999999999997, "-1": 63.32}, "admin_group": {"1": 0.01, "0": 0.02, "2": 0.02, "-1": 0.089999999999999997}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                                                               
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 27.920000000000002, "0": 28.18, "2": 27.949999999999999, "-1": 27.629999999999999}, "rg2_cpu_test": {"1": 62.170000000000002, "0": 62.119999999999997, "2": 62.350000000000001, "-1": 60.600000000000001}, "admin_group": {"1": 0.029999999999999999, "0": 0.01, "2": 0.02, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                   
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 29.350000000000001, "0": 29.350000000000001, "2": 29.359999999999999, "-1": 29.600000000000001}, "rg2_cpu_test": {"1": 60.68, "0": 60.689999999999998, "2": 60.700000000000003, "-1": 60.82}, "admin_group": {"1": 0.02, "0": 0.01, "2": 0.01, "-1": 0.11}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
SELECT fetch_sample();
 fetch_sample                                                                                                                                                                                                                                                                                                                                                                                               
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rg1_cpu_test": {"1": 27.969999999999999, "0": 27.84, "2": 27.760000000000002, "-1": 27.399999999999999}, "rg2_cpu_test": {"1": 62.109999999999999, "0": 62.149999999999999, "2": 62.159999999999997, "-1": 60.960000000000001}, "admin_group": {"1": 0.02, "0": 0.029999999999999999, "2": 0.029999999999999999, "-1": 0.10000000000000001}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}} 
(1 row)
SELECT pg_sleep(1.7);
 pg_sleep 
----------
          
(1 row)
-- end_ignore

SELECT verify_cpu_usage('rg1_cpu_test', 30, 10);
 verify_cpu_usage 
------------------
 t                
(1 row)
SELECT verify_cpu_usage('rg2_cpu_test', 60, 10);
 verify_cpu_usage 
------------------
 t                
(1 row)

-- start_ignore
SELECT * FROM cancel_all;
 pg_cancel_backend 
-------------------
 t                 
 t                 
 t                 
 t                 
 t                 
 t                 
 t                 
 t                 
 t                 
 t                 
(10 rows)

10<:  <... completed>
ERROR:  canceling statement due to user request
11<:  <... completed>
ERROR:  canceling statement due to user request
12<:  <... completed>
ERROR:  canceling statement due to user request
13<:  <... completed>
ERROR:  canceling statement due to user request
14<:  <... completed>
ERROR:  canceling statement due to user request

20<:  <... completed>
ERROR:  canceling statement due to user request
21<:  <... completed>
ERROR:  canceling statement due to user request
22<:  <... completed>
ERROR:  canceling statement due to user request
23<:  <... completed>
ERROR:  canceling statement due to user request
24<:  <... completed>
ERROR:  canceling statement due to user request
-- end_ignore

-- restore admin_group's cpu_rate_limit
ALTER RESOURCE GROUP admin_group SET cpu_rate_limit 10;
ALTER

-- cleanup
REVOKE ALL ON FUNCTION busy() FROM role1_cpu_test;
REVOKE
REVOKE ALL ON FUNCTION busy() FROM role2_cpu_test;
REVOKE
DROP ROLE role1_cpu_test;
DROP
DROP ROLE role2_cpu_test;
DROP
DROP RESOURCE GROUP rg1_cpu_test;
DROP
DROP RESOURCE GROUP rg2_cpu_test;
DROP
DROP LANGUAGE plpythonu CASCADE;
DROP
